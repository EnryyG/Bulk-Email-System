<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Trade - Email Editor (SISTEMA FINALE)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f4f7f5 0%, #e8f5e8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(67, 176, 71, 0.12);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #43b047 0%, #2d5016 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .server-status {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .server-online {
            background: rgba(40, 167, 69, 0.9);
            color: white;
        }

        .server-offline {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 80vh;
        }

        .editor-panel {
            padding: 40px;
            background: #fafafa;
            border-right: 1px solid #e0e0e0;
        }

        .preview-panel {
            padding: 40px;
            background: white;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #43b047;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 1;
            min-width: 150px;
            position: relative;
        }

        .btn-primary {
            background: linear-gradient(135deg, #43b047 0%, #2d5016 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 176, 71, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #2d3436;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        hr {
            border: none;
            border-top: 2px solid #e8f5e8;
            margin: 30px 0;
            position: relative;
        }

        hr::after {
            content: "📧 INVIO DIRETTO";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #fafafa;
            padding: 0 15px;
            font-size: 12px;
            font-weight: 600;
            color: #43b047;
            letter-spacing: 1px;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #43b047;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .preview-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .preview-title {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #2d3436;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 14px;
        }

        .email-preview {
            transform: scale(0.7);
            transform-origin: top left;
            width: 142.857%;
            height: auto;
        }

        .instructions {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border-left: 4px solid #43b047;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 8px 8px 0;
        }

        .instructions h3 {
            color: #2d5016;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #2d3436;
            line-height: 1.6;
        }

        .quick-actions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .quick-actions h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .quick-actions button {
            background: #ffc107;
            border: none;
            color: #212529;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .email-preview {
                transform: scale(1);
                width: 100%;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #2d3436;
        }

        .code-output {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        /* STILI BULK EMAIL */
        .mode-switcher {
            position: absolute;
            top: 15px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px; 
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .recipients-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e8f5e8;
        }

        .recipients-section h4 {

            color: #2d5016;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .recipients-section h5 {
            color: #43b047;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
        }

        .csv-upload-area {
            background: #fff3cd;
            border: 2px dashed #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .csv-upload-area:hover {
            border-color: #43b047;
            background: #f0fff0;
        }

        .csv-upload-area.dragover {
            border-color: #43b047;
            background: #e8f5e8;
            transform: scale(1.02);
        }

        .manual-add-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 15px;
        }

        .manual-add-grid input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .manual-add-grid button {
            background: #43b047;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .manual-add-grid button:hover {
            background: #2d5016;
            transform: translateY(-1px);
        }

        .recipients-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }

        .recipient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .recipient-item:hover {
            background: #f8f9fa;
        }

        .recipient-item:last-child {
            border-bottom: none;
        }

        .recipient-info {
            flex-grow: 1;
        }

        .recipient-email {
            font-weight: 600;
            color: #2d3436;
        }

        .recipient-details {
            font-size: 12px;
            color: #636e72;
            margin-top: 2px;
        }

        .remove-recipient {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .remove-recipient:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .bulk-progress {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border: 1px solid #e8f5e8;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 8px;
            height: 16px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #43b047, #2d5016);
            height: 100%;
            width: 0%;
            border-radius: 8px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 35%, rgba(255,255,255,0.2) 50%, transparent 65%);
            animation: progressShine 2s linear infinite;
        }

        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .stat-card {
            text-align: center;
            background: white;
            padding: 12px 8px;
            border-radius: 8px;
            border: 1px solid #e8f5e8;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 176, 71, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #636e72;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bulk-logs {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e8f5e8;
        }

        .log-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            border-left: 3px solid;
        }

        .log-success {
            background: rgba(40, 167, 69, 0.1);
            border-left-color: #28a745;
            color: #155724;
        }

        .log-error {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: #dc3545;
            color: #721c24;
        }

        .log-info {
            background: rgba(23, 162, 184, 0.1);
            border-left-color: #17a2b8;
            color: #0c5460;
        }

        @media (max-width: 768px) {
            .mode-switcher {
                position: static;
                justify-content: center;
                margin-bottom: 20px;
            }
            
            .manual-add-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="mode-switcher">
                <button class="mode-btn active" onclick="switchMode('single')">📧 Single</button>
                <button class="mode-btn" onclick="switchMode('bulk')">📤 Bulk</button>
            </div>
            <div id="serverStatus" class="server-status server-offline">🔴 Offline</div>
            <h1>📧 Email Editor Flex Trade</h1>
            <p>Sistema finale - Invio email professionale automatico</p>
        </div>

        <div class="content">
            <!-- SEZIONE SINGLE EMAIL -->
            <div id="singleSection" class="editor-panel">
                <div class="instructions">
                    <h3>📝 Sistema Pronto per l'Uso</h3>
                    <p><strong>ZERO configurazione richiesta!</strong> Compila i campi, clicca "Invia Email" e il sistema farà tutto automaticamente. Le email vengono inviate dal server aziendale.</p>
                </div>

                <div class="quick-actions">
                    <h4>⚡ Azioni Rapide</h4>
                    <button onclick="fillTestData()">📝 Dati Test</button>
                    <button onclick="checkServer()">🔧 Test Server</button>
                    <button onclick="clearAll()">🗑️ Pulisci Tutto</button>
                </div>

                <div id="statusMessage" class="status-message"></div>

                <form id="emailForm">
                    <div class="form-group">
                        <label for="badge">🏷️ Badge Header</label>
                        <input type="text" id="badge" value="Nouvelle Collection Militaire" placeholder="es: Offre Spéciale">
                    </div>

                    <div class="form-group">
                        <label for="mainContent">📄 Contenuto Principale</label>
                        <textarea id="mainContent" placeholder="Descrivi qui il prodotto o servizio che vuoi promuovere">Nous sommes heureux de vous annoncer que nous venons de recevoir un nouveau stock de vêtements militaires. Nous avons une large sélection de vêtements de haute qualité, allant des uniformes complets aux accessoires tels que des sacs à dos, des casquettes et des gants.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="highlightContent">⭐ Contenuto Evidenziato</label>
                        <textarea id="highlightContent" placeholder="Call-to-action o informazioni importanti">Si vous êtes intéressé par notre nouvelle collection, n'hésitez pas à nous contacter par e-mail. Nous serons ravis de répondre à vos questions et de vous fournir toutes les informations dont vous avez besoin.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="additionalDetails">📋 Dettagli Aggiuntivi</label>
                        <textarea id="additionalDetails" placeholder="Informazioni supplementari">Nos produits sont conçus pour les professionnels et les amateurs de militaria, et sont disponibles à des prix compétitifs.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="conclusion">🎯 Conclusione</label>
                        <textarea id="conclusion" placeholder="Messaggio di chiusura">Nous espérons que vous trouverez ce que vous cherchez et que vous apprécierez nos produits.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="ctaText">🔘 Testo Bottone</label>
                        <input type="text" id="ctaText" value="Contactez-nous" placeholder="es: Demander Info">
                    </div>

                    <div class="form-group">
                        <label for="emailContact">📧 Email di Contatto</label>
                        <select id="emailContact">
                            <option value="info">info@flextrade.it</option>
                            <option value="contact">contact@flextrade.it</option>
                            <option value="commercial">commercial@flextrade.it</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="emailSubject">📋 Oggetto Email</label>
                        <input type="text" id="emailSubject" value="Demande d'information - Vêtements militaires" placeholder="Oggetto dell'email">
                    </div>

                    <div class="form-group">
                        <label for="signature">✍️ Firma</label>
                        <input type="text" id="signature" value="L'équipe FLEX TRADE" placeholder="es: Mario Rossi - FLEX TRADE">
                    </div>

                    <hr>

                    <div class="form-group">
                        <label for="recipientEmail">👤 Email Destinatario</label>
                        <input type="email" id="recipientEmail" placeholder="cliente@example.com" required>
                    </div>

                    <div class="form-group">
                        <label for="recipientName">📝 Nome Destinatario (opzionale)</label>
                        <input type="text" id="recipientName" placeholder="Nome del cliente">
                    </div>

                    <div class="form-group">
                        <label for="senderName">👨‍💼 Il tuo Nome</label>
                        <input type="text" id="senderName" placeholder="Il tuo nome" required>
                    </div>

                    <div class="form-group">
                        <label for="senderEmail">📧 La tua Email</label>
                        <select id="senderEmail" required>
                            <option value="">Seleziona la tua email</option>
                            <option value="info@flextrade.it">info@flextrade.it</option>
                            <option value="contact@flextrade.it">contact@flextrade.it</option>
                            <option value="commercial@flextrade.it">commercial@flextrade.it</option>
                            <option value="admin@flextrade.it">admin@flextrade.it</option>
                        </select>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" id="sendBtn" onclick="sendEmail()">📤 Invia Email</button>
                        <button type="button" class="btn btn-secondary" onclick="generateEmail()">🔧 Genera Codice</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">🔄 Reset</button>
                    </div>
                </form>
            </div>

            <!-- SEZIONE BULK EMAIL -->
            <div id="bulkSection" class="editor-panel" style="display: none;">
                <div class="instructions">
                    <h3>📤 Invio Email in Massa (BULK)</h3>
                    <p><strong>Sistema BULK avanzato!</strong> Usa lo stesso template professionale per inviare email personalizzate a centinaia di destinatari. Importa da CSV o aggiungi manualmente.</p>
                </div>

                <!-- Gestione destinatari -->
                <div class="recipients-section">
                    <h4>👥 Gestione Destinatari</h4>
                    
                    <!-- Upload CSV -->
                    <div style="margin-bottom: 20px;">
                        <h5>📁 Importa da File CSV</h5>
                        <div class="csv-upload-area" ondrop="handleCSVDrop(event)" ondragover="handleCSVDragOver(event)" ondragleave="handleCSVDragLeave(event)">
                            <p><strong>📋 Formato CSV richiesto:</strong></p>
                            <code>email,nome,azienda,cognome</code><br>
                            <small style="color: #666;">Esempio: mario@gmail.com,Mario,ACME,Rossi</small>
                            <br><br>
                            <input type="file" id="csvFile" accept=".csv" onchange="handleCSVUpload(event)" style="display: none;">
                            <button onclick="document.getElementById('csvFile').click()" style="background: #43b047; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                📎 Seleziona File CSV
                            </button>
                            <p style="margin-top: 10px; color: #666; font-size: 12px;">Oppure trascina qui il file CSV</p>
                        </div>
                    </div>

                    <!-- Aggiungi manualmente -->
                    <div style="margin-bottom: 20px;">
                        <h5>➕ Aggiungi Manualmente</h5>
                        <div class="manual-add-grid">
                            <input type="email" id="manualEmail" placeholder="cliente@example.com" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="manualName" placeholder="Nome" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <input type="text" id="manualCompany" placeholder="Azienda" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addManualRecipient()">➕ Aggiungi</button>
                        </div>
                    </div>

                    <!-- Lista destinatari -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5>📋 Lista Destinatari (<span id="recipientCount">0</span>)</h5>
                            <button onclick="clearAllRecipients()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">🗑️ Svuota</button>
                        </div>
                        <div id="recipientsList" class="recipients-list">
                            <div style="padding: 20px; text-align: center; color: #666;">
                                <p>🚫 Nessun destinatario aggiunto</p>
                                <small>Importa da CSV o aggiungi manualmente per iniziare</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="bulkStatusMessage" class="status-message"></div>

                <!-- Template BULK con stessi campi del single -->
                <form id="bulkEmailForm">
                    <div class="form-group">
                        <label for="bulkBadge">🏷️ Badge Header</label>
                        <input type="text" id="bulkBadge" value="Nouvelle Collection Militaire" placeholder="es: Offre Spéciale">
                    </div>

                    <div class="form-group">
                        <label for="bulkMainContent">📄 Contenuto Principale (usa {{nome}}, {{azienda}}, {{cognome}})</label>
                        <textarea id="bulkMainContent" placeholder="Usa {{nome}}, {{azienda}}, {{cognome}} per personalizzare">Bonjour {{nome}},

Nous sommes heureux de vous annoncer que nous venons de recevoir un nouveau stock de vêtements militaires. {{#azienda}}Nous savons que {{azienda}} recherche des équipements de qualité{{/azienda}} et nous avons une large sélection de vêtements de haute qualité, allant des uniformes complets aux accessoires tels que des sacs à dos, des casquettes et des gants.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="bulkHighlightContent">⭐ Contenuto Evidenziato</label>
                        <textarea id="bulkHighlightContent" placeholder="Call-to-action o informazioni importanti">Si vous êtes intéressé par notre nouvelle collection, n'hésitez pas à nous contacter par e-mail. Nous serons ravis de répondre à vos questions et de vous fournir toutes les informations dont vous avez besoin.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="bulkAdditionalDetails">📋 Dettagli Aggiuntivi</label>
                        <textarea id="bulkAdditionalDetails" placeholder="Informazioni supplementari">Nos produits sont conçus pour les professionnels et les amateurs de militaria, et sont disponibles à des prix compétitifs.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="bulkConclusion">🎯 Conclusione</label>
                        <textarea id="bulkConclusion" placeholder="Messaggio di chiusura">Nous espérons que vous trouverez ce que vous cherchez et que vous apprécierez nos produits.</textarea>
                    </div>

                    <div class="form-group">
                        <label for="bulkCtaText">🔘 Testo Bottone</label>
                        <input type="text" id="bulkCtaText" value="Contactez-nous" placeholder="es: Demander Info">
                    </div>

                    <div class="form-group">
                        <label for="bulkEmailContact">📧 Email di Contatto</label>
                        <select id="bulkEmailContact">
                            <option value="info">info@flextrade.it</option>
                            <option value="contact">contact@flextrade.it</option>
                            <option value="commercial">commercial@flextrade.it</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="bulkEmailSubject">📋 Oggetto Email (usa {{nome}}, {{azienda}}, etc.)</label>
                        <input type="text" id="bulkEmailSubject" value="Demande d'information - {{nome}} - Vêtements militaires" placeholder="Oggetto personalizzabile">
                    </div>

                    <div class="form-group">
                        <label for="bulkSignature">✍️ Firma</label>
                        <input type="text" id="bulkSignature" value="L'équipe FLEX TRADE" placeholder="es: Mario Rossi - FLEX TRADE">
                    </div>

                    <hr>

                    <div class="form-group">
                        <label for="bulkSenderName">👨‍💼 Il tuo Nome</label>
                        <input type="text" id="bulkSenderName" placeholder="Il tuo nome" required>
                    </div>

                    <div class="form-group">
                        <label for="bulkSenderEmail">📧 La tua Email</label>
                        <select id="bulkSenderEmail" required>
                            <option value="">Seleziona la tua email</option>
                            <option value="info@flextrade.it">info@flextrade.it</option>
                            <option value="contact@flextrade.it">contact@flextrade.it</option>
                            <option value="commercial@flextrade.it">commercial@flextrade.it</option>
                            <option value="admin@flextrade.it">admin@flextrade.it</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sendInterval">⏱️ Intervallo tra invii</label>
                        <select id="sendInterval">
                            <option value="1">1 secondo (Veloce)</option>
                            <option value="2" selected>2 secondi (Consigliato)</option>
                            <option value="3">3 secondi (Sicuro)</option>
                            <option value="5">5 secondi (Molto Sicuro)</option>
                        </select>
                    </div>

                    <!-- Progress BULK -->
                    <div id="bulkProgress" class="bulk-progress" style="display: none;">
                        <h5>📊 Progresso Invio</h5>
                        <div class="progress-bar-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div id="totalEmails" class="stat-number" style="color: #43b047;">0</div>
                                <div class="stat-label">Totale</div>
                            </div>
                            <div class="stat-card">
                                <div id="sentEmails" class="stat-number" style="color: #28a745;">0</div>
                                <div class="stat-label">Inviate</div>
                            </div>
                            <div class="stat-card">
                                <div id="failedEmails" class="stat-number" style="color: #dc3545;">0</div>
                                <div class="stat-label">Fallite</div>
                            </div>
                            <div class="stat-card">
                                <div id="remainingEmails" class="stat-number" style="color: #17a2b8;">0</div>
                                <div class="stat-label">Rimanenti</div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" id="startBulkBtn" onclick="startBulkSend()" class="btn btn-primary">🚀 Inizia Invio BULK (<span id="emailCount">0</span> email)</button>
                        <button type="button" id="stopBulkBtn" onclick="stopBulkSend()" class="btn btn-secondary" style="display: none;">⏹️ Ferma Invio</button>
                        <button type="button" onclick="previewBulkEmail()" class="btn btn-secondary">👁️ Anteprima</button>
                        <button type="button" onclick="resetBulkForm()" class="btn btn-secondary">� Reset</button>
                    </div>
                </form>

                <!-- Log BULK -->
                <div id="bulkLogs" class="bulk-logs" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h5>📊 Log degli Invii</h5>
                        <button onclick="clearBulkLogs()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">🗑️ Pulisci</button>
                    </div>
                    <div id="logContainer"></div>
                </div>
            </div>

            <div class="preview-panel">
                <div class="preview-container">
                    <div class="preview-title">�📱 Anteprima Email</div>
                    <div id="emailPreview" class="email-preview">
                        <!-- L'anteprima verrà inserita qui -->
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per il codice generato -->
    <div id="codeModal" class="modal">
        <div class="modal-content">
            <h3>📧 Codice Email Generato</h3>
            <p>Copia tutto il codice qui sotto e incollalo in Gmail usando il pulsante HTML (<code>&lt;&gt;</code>):</p>
            <div id="generatedCode" class="code-output"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="copyCode()">📋 Copia Codice</button>
                <button class="btn btn-secondary" onclick="closeModal()">❌ Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        // 🚀 TEMPLATE EMAIL GMAIL-COMPATIBILE AL 100%
        // ✅ Solo HTML + CSS inline + table
        // ✅ Testato su Gmail, Outlook, Apple Mail, Yahoo
        // ✅ Responsive e leggero (< 50KB)
        // ✅ Design moderno ma sicuro
        const emailTemplate = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flex Trade</title>
</head>
<body style="margin:0;padding:0;background-color:#f4f7f5;font-family:Arial,sans-serif;">

<!-- CONTAINER PRINCIPALE -->
<table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;background-color:#f4f7f5;">
  <tr>
    <td align="center" style="padding:20px 10px;">
      
      <!-- EMAIL WRAPPER -->
      <table cellpadding="0" cellspacing="0" border="0" width="600" style="border-collapse:collapse;max-width:600px;width:100%;background-color:#ffffff;border:1px solid #e0e0e0;">
        
        <!-- HEADER CON LOGO -->
        <tr>
          <td style="background-color:#43b047;padding:30px 20px;text-align:center;">
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;">
              <tr>
                <td style="text-align:center;">
                  <!-- Logo testo FLEX TRADE -->
                  <div style="font-family:Arial,sans-serif;font-weight:bold;font-size:42px;color:#ffffff;letter-spacing:2px;margin:0;line-height:1;">FLEX</div>
                  <div style="font-family:Arial,sans-serif;font-weight:bold;font-size:18px;color:#d4edda;letter-spacing:3px;margin:5px 0 15px 0;line-height:1;">TRADE</div>
                  <!-- Badge -->
                  <div style="background-color:#ffffff;color:#43b047;font-weight:bold;font-size:12px;padding:8px 16px;border-radius:15px;display:inline-block;letter-spacing:1px;text-transform:uppercase;margin:0;">{{BADGE}}</div>
                </td>
              </tr>
            </table>
          </td>
        </tr>

        <!-- CONTENUTO PRINCIPALE -->
        <tr>
          <td style="padding:30px 25px;background-color:#ffffff;">
            
            <!-- Saluto personalizzato -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin-bottom:20px;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:16px;line-height:1.5;color:#333333;font-weight:bold;">
                  Bonjour {{RECIPIENT_NAME}},
                </td>
              </tr>
            </table>

            <!-- Contenuto principale -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin-bottom:20px;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:15px;line-height:1.6;color:#333333;">
                  {{MAIN_CONTENT}}
                </td>
              </tr>
            </table>

            <!-- Box evidenziato verde -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin:20px 0;">
              <tr>
                <td style="background-color:#f0fff0;border-left:4px solid #43b047;padding:15px 20px;">
                  <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;">
                    <tr>
                      <td style="font-family:Arial,sans-serif;font-size:15px;line-height:1.6;color:#2d5016;font-weight:bold;">
                        {{HIGHLIGHT_CONTENT}}
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>

            <!-- Dettagli prodotti -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin-bottom:20px;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:15px;line-height:1.6;color:#333333;">
                  {{ADDITIONAL_DETAILS}}
                </td>
              </tr>
            </table>

            <!-- Conclusione -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin-bottom:25px;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:15px;line-height:1.6;color:#333333;">
                  {{CONCLUSION}}
                </td>
              </tr>
            </table>

            <!-- BOTTONE CALL-TO-ACTION -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin:25px 0;text-align:center;">
              <tr>
                <td style="text-align:center;">
                  <table cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;margin:0 auto;">
                    <tr>
                      <td style="background-color:#43b047;border-radius:20px;text-align:center;">
                        <a href="mailto:{{EMAIL_CONTACT}}@flextrade.it?subject={{EMAIL_SUBJECT}}" style="display:inline-block;padding:12px 25px;font-family:Arial,sans-serif;font-size:14px;font-weight:bold;color:#ffffff;text-decoration:none;text-transform:uppercase;letter-spacing:1px;">{{CTA_TEXT}}</a>
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>

            <!-- Firma -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin-top:25px;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:15px;color:#333333;line-height:1.4;">
                  <strong>Cordialement,</strong><br>
                  <span style="color:#43b047;font-weight:bold;">{{SIGNATURE}}</span>
                </td>
              </tr>
            </table>

          </td>
        </tr>

        <!-- FOOTER -->
        <tr>
          <td style="background-color:#f8f9fa;padding:25px;text-align:center;border-top:1px solid #e0e0e0;">
            
            <!-- Partners -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin-bottom:15px;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:12px;font-weight:bold;color:#666666;text-transform:uppercase;letter-spacing:1px;text-align:center;margin-bottom:10px;">
                  Nos Partenaires de Confiance
                </td>
              </tr>
            </table>

            <!-- Lista partners -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin-bottom:15px;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:11px;color:#888888;text-align:center;line-height:1.3;">
                  IVECO Defence • COELMO • Hytera • Eagle Security
                </td>
              </tr>
            </table>

            <!-- Divider -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;margin:15px 0;">
              <tr>
                <td style="border-top:1px solid #e0e0e0;font-size:1px;line-height:1px;">&nbsp;</td>
              </tr>
            </table>

            <!-- Link sito web -->
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse:collapse;">
              <tr>
                <td style="font-family:Arial,sans-serif;font-size:12px;color:#666666;text-align:center;">
                  Découvrez notre site web : 
                  <a href="https://flextrade.it" target="_blank" style="color:#43b047;font-weight:bold;text-decoration:none;">flextrade.it</a>
                </td>
              </tr>
            </table>

          </td>
        </tr>

      </table>
      
    </td>
  </tr>
</table>

</body>
</html>`;

        // Variabili globali
        let serverOnline = false;
        let recipients = [];
        let bulkSending = false;
        let bulkAbortController = null;

        // Funzione per controllare lo stato del server
        async function checkServer() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                if (data.success) {
                    serverOnline = true;
                    updateServerStatus(true);
                    showStatus('success', '✅ Server email online e funzionante!');
                } else {
                    throw new Error('Server non risponde correttamente');
                }
            } catch (error) {
                serverOnline = false;
                updateServerStatus(false);
                showStatus('error', '❌ Server offline! Avvia il server con: npm start');
            }
        }

        // Aggiorna l'indicatore di stato del server
        function updateServerStatus(online) {
            const statusEl = document.getElementById('serverStatus');
            if (online) {
                statusEl.className = 'server-status server-online';
                statusEl.textContent = '🟢 Online';
            } else {
                statusEl.className = 'server-status server-offline';
                statusEl.textContent = '🔴 Offline';
            }
        }

        // Funzione per inviare email
        async function sendEmail() {
            // Validazione campi
            const recipientEmail = document.getElementById('recipientEmail').value;
            const senderName = document.getElementById('senderName').value;
            const senderEmail = document.getElementById('senderEmail').value;
            const emailSubject = document.getElementById('emailSubject').value;

            if (!recipientEmail || !senderName || !senderEmail) {
                showStatus('error', '❌ Compila tutti i campi obbligatori!');
                return;
            }

            if (!isValidEmail(recipientEmail)) {
                showStatus('error', '❌ Inserisci un indirizzo email valido!');
                return;
            }

            // Controlla se il server è online
            if (!serverOnline) {
                showStatus('error', '❌ Server offline! Clicca "Test Server" o avvia il server.');
                return;
            }

            // Mostra loading
            showStatus('loading', '<span class="loading-spinner"></span>Invio email in corso...');
            document.getElementById('sendBtn').disabled = true;

            try {
                // Genera l'HTML dell'email
                updatePreview();
                
                // Prepara i dati per l'invio
                const emailData = {
                    to: recipientEmail,
                    from: senderEmail,
                    fromName: senderName,
                    subject: emailSubject,
                    html: document.getElementById('emailPreview').innerHTML,
                    recipientName: document.getElementById('recipientName').value || 'Client'
                };

                // Invia al server Node.js
                const response = await fetch('/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('success', `✅ ${result.message} (ID: ${result.messageId})`);
                } else {
                    throw new Error(result.message);
                }

            } catch (error) {
                showStatus('error', `❌ Errore: ${error.message}`);
                console.error('Errore invio email:', error);
            } finally {
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // Funzioni di utilità
        function fillTestData() {
            document.getElementById('recipientEmail').value = 'test@example.com';
            document.getElementById('recipientName').value = 'Cliente Test';
            document.getElementById('senderName').value = 'Mario Rossi';
            document.getElementById('senderEmail').value = 'info@flextrade.it';
            showStatus('success', '📝 Dati di test inseriti!');
        }

        function clearAll() {
            if (confirm('Vuoi davvero cancellare tutti i campi?')) {
                document.getElementById('emailForm').reset();
                showStatus('success', '🗑️ Tutti i campi sono stati cancellati!');
            }
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message status-${type}`;
            statusEl.innerHTML = message;
            statusEl.style.display = 'block';

            if (type !== 'loading') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 6000);
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function updatePreview() {
            const badge = document.getElementById('badge').value;
            const mainContent = document.getElementById('mainContent').value;
            const highlightContent = document.getElementById('highlightContent').value;
            const additionalDetails = document.getElementById('additionalDetails').value;
            const conclusion = document.getElementById('conclusion').value;
            const ctaText = document.getElementById('ctaText').value;
            const emailContact = document.getElementById('emailContact').value;
            const emailSubject = encodeURIComponent(document.getElementById('emailSubject').value);
            const signature = document.getElementById('signature').value;
            const recipientName = document.getElementById('recipientName').value || 'Client';

            let preview = emailTemplate
                .replace(/\{\{BADGE\}\}/g, badge)
                .replace(/\{\{MAIN_CONTENT\}\}/g, mainContent.replace(/\n/g, '<br>'))
                .replace(/\{\{HIGHLIGHT_CONTENT\}\}/g, highlightContent.replace(/\n/g, '<br>'))
                .replace(/\{\{ADDITIONAL_DETAILS\}\}/g, additionalDetails.replace(/\n/g, '<br>'))
                .replace(/\{\{CONCLUSION\}\}/g, conclusion.replace(/\n/g, '<br>'))
                .replace(/\{\{CTA_TEXT\}\}/g, ctaText)
                .replace(/\{\{EMAIL_CONTACT\}\}/g, emailContact)
                .replace(/\{\{EMAIL_SUBJECT\}\}/g, emailSubject)
                .replace(/\{\{SIGNATURE\}\}/g, signature)
                .replace(/\{\{RECIPIENT_NAME\}\}/g, recipientName);

            document.getElementById('emailPreview').innerHTML = preview;
        }

        function generateEmail() {
            updatePreview();
            document.getElementById('generatedCode').textContent = document.getElementById('emailPreview').innerHTML;
            document.getElementById('codeModal').style.display = 'block';
        }

        function copyCode() {
            const code = document.getElementById('generatedCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('✅ Codice copiato! Ora puoi incollarlo in Gmail.');
            });
        }

        function closeModal() {
            document.getElementById('codeModal').style.display = 'none';
        }

        function resetForm() {
            if (confirm('Sei sicuro di voler resettare tutti i campi?')) {
                document.getElementById('emailForm').reset();
                document.getElementById('badge').value = 'Nouvelle Collection Militaire';
                document.getElementById('mainContent').value = 'Nous sommes heureux de vous annoncer que nous venons de recevoir un nouveau stock de vêtements militaires. Nous avons une large sélection de vêtements de haute qualité, allant des uniformes complets aux accessoires tels que des sacs à dos, des casquettes et des gants.';
                document.getElementById('highlightContent').value = 'Si vous êtes intéressé par notre nouvelle collection, n\'hésitez pas à nous contacter par e-mail. Nous serons ravis de répondre à vos questions et de vous fournir toutes les informations dont vous avez besoin.';
                document.getElementById('additionalDetails').value = 'Nos produits sont conçus pour les professionnels et les amateurs de militaria, et sont disponibles à des prix compétitifs.';
                document.getElementById('conclusion').value = 'Nous espérons que vous trouverez ce que vous cherchez et que vous apprécierez nos produits.';
                document.getElementById('ctaText').value = 'Contactez-nous';
                document.getElementById('emailSubject').value = 'Demande d\'information - Vêtements militaires';
                document.getElementById('signature').value = 'L\'équipe FLEX TRADE';
                
                updatePreview();
                showStatus('success', '✅ Modulo resettato ai valori di default!');
            }
        }

        // ===== FUNZIONI BULK EMAIL =====

        // Switch tra modalità Single e Bulk
        function switchMode(mode) {
            const singleSection = document.getElementById('singleSection');
            const bulkSection = document.getElementById('bulkSection');
            const modeBtns = document.querySelectorAll('.mode-btn');

            if (mode === 'single') {
                singleSection.style.display = 'block';
                bulkSection.style.display = 'none';
                modeBtns[0].classList.add('active');
                modeBtns[1].classList.remove('active');
                document.querySelector('.preview-title').textContent = '📱 Anteprima Email';
                updatePreview();
            } else {
                singleSection.style.display = 'none';
                bulkSection.style.display = 'block';
                modeBtns[0].classList.remove('active');
                modeBtns[1].classList.add('active');
                document.querySelector('.preview-title').textContent = '📱 Anteprima BULK';
                updateBulkPreview();
            }
        }

        // Gestione CSV Upload
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'text/csv') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            } else {
                showBulkStatus('error', '❌ Seleziona un file CSV valido!');
            }
        }

        // Gestione Drag & Drop CSV
        function handleCSVDrop(event) {
            event.preventDefault();
            const uploadArea = event.target.closest('.csv-upload-area');
            uploadArea.classList.remove('dragover');
            
            const file = event.dataTransfer.files[0];
            if (file && file.type === 'text/csv') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            } else {
                showBulkStatus('error', '❌ Trascina un file CSV valido!');
            }
        }

        function handleCSVDragOver(event) {
            event.preventDefault();
            const uploadArea = event.target.closest('.csv-upload-area');
            uploadArea.classList.add('dragover');
        }

        function handleCSVDragLeave(event) {
            const uploadArea = event.target.closest('.csv-upload-area');
            uploadArea.classList.remove('dragover');
        }

        // Parse CSV
        function parseCSV(csvText) {
            try {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) {
                    throw new Error('Il file CSV deve contenere almeno una riga di intestazione e una di dati');
                }

                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const expectedHeaders = ['email', 'nome', 'azienda', 'cognome'];
                
                if (!expectedHeaders.every(h => headers.includes(h))) {
                    throw new Error('Il CSV deve contenere le colonne: email, nome, azienda, cognome');
                }

                let newRecipients = 0;
                let duplicates = 0;

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    if (values.length >= headers.length) {
                        const recipient = {};
                        headers.forEach((header, index) => {
                            recipient[header] = values[index] || '';
                        });

                        if (recipient.email && isValidEmail(recipient.email)) {
                            if (!recipients.find(r => r.email === recipient.email)) {
                                recipients.push(recipient);
                                newRecipients++;
                            } else {
                                duplicates++;
                            }
                        }
                    }
                }

                updateRecipientsList();
                showBulkStatus('success', `✅ CSV importato! ${newRecipients} nuovi destinatari aggiunti${duplicates > 0 ? `, ${duplicates} duplicati ignorati` : ''}`);
            } catch (error) {
                showBulkStatus('error', `❌ Errore CSV: ${error.message}`);
            }
        }

        // Aggiungi destinatario manualmente
        function addManualRecipient() {
            const email = document.getElementById('manualEmail').value.trim();
            const name = document.getElementById('manualName').value.trim();
            const company = document.getElementById('manualCompany').value.trim();

            if (!email) {
                showBulkStatus('error', '❌ Inserisci almeno l\'email!');
                return;
            }

            if (!isValidEmail(email)) {
                showBulkStatus('error', '❌ Inserisci un indirizzo email valido!');
                return;
            }

            if (recipients.find(r => r.email === email)) {
                showBulkStatus('error', '❌ Email già presente nella lista!');
                return;
            }

            recipients.push({
                email: email,
                nome: name,
                azienda: company,
                cognome: ''
            });

            // Pulisci i campi
            document.getElementById('manualEmail').value = '';
            document.getElementById('manualName').value = '';
            document.getElementById('manualCompany').value = '';

            updateRecipientsList();
            showBulkStatus('success', `✅ Destinatario aggiunto: ${email}`);
        }

        // Aggiorna lista destinatari
        function updateRecipientsList() {
            const list = document.getElementById('recipientsList');
            const count = document.getElementById('recipientCount');
            const emailCount = document.getElementById('emailCount');

            count.textContent = recipients.length;
            emailCount.textContent = recipients.length;

            if (recipients.length === 0) {
                list.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p>🚫 Nessun destinatario aggiunto</p>
                        <small>Importa da CSV o aggiungi manualmente per iniziare</small>
                    </div>
                `;
            } else {
                list.innerHTML = recipients.map((recipient, index) => `
                    <div class="recipient-item">
                        <div class="recipient-info">
                            <div class="recipient-email">${recipient.email}</div>
                            <div class="recipient-details">
                                ${recipient.nome || 'Nome non specificato'}
                                ${recipient.azienda ? ` - ${recipient.azienda}` : ''}
                                ${recipient.cognome ? ` ${recipient.cognome}` : ''}
                            </div>
                        </div>
                        <button class="remove-recipient" onclick="removeRecipient(${index})">🗑️</button>
                    </div>
                `).join('');
            }
        }

        // Rimuovi destinatario
        function removeRecipient(index) {
            const removed = recipients.splice(index, 1)[0];
            updateRecipientsList();
            showBulkStatus('success', `✅ Rimosso: ${removed.email}`);
        }

        // Pulisci tutti i destinatari
        function clearAllRecipients() {
            if (recipients.length === 0) return;
            
            if (confirm(`Vuoi davvero rimuovere tutti i ${recipients.length} destinatari?`)) {
                recipients = [];
                updateRecipientsList();
                showBulkStatus('success', '✅ Lista destinatari svuotata!');
            }
        }

        // Sostituisce le variabili nel template
        function replaceTemplateVariables(template, recipient, senderName, senderEmail) {
            let result = template;
            
            // Sostituzioni base
            result = result.replace(/\{\{nome\}\}/g, recipient.nome || 'Cliente');
            result = result.replace(/\{\{azienda\}\}/g, recipient.azienda || '');
            result = result.replace(/\{\{cognome\}\}/g, recipient.cognome || '');
            result = result.replace(/\{\{mittente\}\}/g, senderName || 'Team FlexTrade');
            result = result.replace(/\{\{email_mittente\}\}/g, senderEmail || 'info@flextrade.it');
            
            // Gestione condizionale per azienda
            if (recipient.azienda) {
                result = result.replace(/\{\{#azienda\}\}(.*?)\{\{\/azienda\}\}/g, '$1');
            } else {
                result = result.replace(/\{\{#azienda\}\}(.*?)\{\{\/azienda\}\}/g, '');
            }
            
            return result;
        }

        // Anteprima BULK
        function previewBulkEmail() {
            if (recipients.length === 0) {
                showBulkStatus('error', '❌ Aggiungi almeno un destinatario per vedere l\'anteprima!');
                return;
            }

            // Usa il primo destinatario per l'anteprima
            const recipient = recipients[0];
            updateBulkPreview(recipient);
            showBulkStatus('success', `👁️ Anteprima generata con i dati di: ${recipient.email}`);
        }

        // Aggiorna anteprima BULK
        function updateBulkPreview(recipient = null) {
            if (!recipient && recipients.length > 0) {
                recipient = recipients[0];
            } else if (!recipient) {
                recipient = { email: 'cliente@example.com', nome: 'Cliente', azienda: 'Azienda Example', cognome: 'Test' };
            }

            const badge = document.getElementById('bulkBadge').value;
            const mainContent = replaceTemplateVariables(document.getElementById('bulkMainContent').value, recipient, 
                document.getElementById('bulkSenderName').value, document.getElementById('bulkSenderEmail').value);
            const highlightContent = replaceTemplateVariables(document.getElementById('bulkHighlightContent').value, recipient,
                document.getElementById('bulkSenderName').value, document.getElementById('bulkSenderEmail').value);
            const additionalDetails = replaceTemplateVariables(document.getElementById('bulkAdditionalDetails').value, recipient,
                document.getElementById('bulkSenderName').value, document.getElementById('bulkSenderEmail').value);
            const conclusion = replaceTemplateVariables(document.getElementById('bulkConclusion').value, recipient,
                document.getElementById('bulkSenderName').value, document.getElementById('bulkSenderEmail').value);
            const ctaText = document.getElementById('bulkCtaText').value;
            const emailContact = document.getElementById('bulkEmailContact').value;
            const emailSubject = encodeURIComponent(replaceTemplateVariables(document.getElementById('bulkEmailSubject').value, recipient,
                document.getElementById('bulkSenderName').value, document.getElementById('bulkSenderEmail').value));
            const signature = replaceTemplateVariables(document.getElementById('bulkSignature').value, recipient,
                document.getElementById('bulkSenderName').value, document.getElementById('bulkSenderEmail').value);

            let preview = emailTemplate
                .replace('{{BADGE}}', badge)
                .replace('{{MAIN_CONTENT}}', mainContent)
                .replace('{{HIGHLIGHT_CONTENT}}', highlightContent)
                .replace('{{ADDITIONAL_DETAILS}}', additionalDetails)
                .replace('{{CONCLUSION}}', conclusion)
                .replace('{{CTA_TEXT}}', ctaText)
                .replace('{{EMAIL_CONTACT}}', emailContact)
                .replace('{{EMAIL_SUBJECT}}', emailSubject)
                .replace('{{SIGNATURE}}', signature)
                .replace('{{RECIPIENT_NAME}}', recipient.nome || 'Client');

            document.getElementById('emailPreview').innerHTML = preview;
        }

        // Inizia invio BULK
        async function startBulkSend() {
            if (recipients.length === 0) {
                showBulkStatus('error', '❌ Aggiungi almeno un destinatario!');
                return;
            }

            const senderName = document.getElementById('bulkSenderName').value.trim();
            const senderEmail = document.getElementById('bulkSenderEmail').value;

            if (!senderName || !senderEmail) {
                showBulkStatus('error', '❌ Compila il nome e l\'email del mittente!');
                return;
            }

            if (!serverOnline) {
                showBulkStatus('error', '❌ Server offline! Controlla la connessione.');
                return;
            }

            bulkSending = true;
            bulkAbortController = new AbortController();
            
            // Mostra progress e nasconde bottone start
            document.getElementById('bulkProgress').style.display = 'block';
            document.getElementById('bulkLogs').style.display = 'block';
            document.getElementById('startBulkBtn').style.display = 'none';
            document.getElementById('stopBulkBtn').style.display = 'inline-block';

            // Inizializza statistiche
            const totalEmails = recipients.length;
            let sentEmails = 0;
            let failedEmails = 0;
            
            updateBulkStats(totalEmails, sentEmails, failedEmails);
            clearBulkLogs();

            const interval = parseInt(document.getElementById('sendInterval').value) * 1000;

            showBulkStatus('loading', '<span class="loading-spinner"></span>Invio BULK in corso...');
            addLog('info', `🚀 Avvio invio BULK di ${totalEmails} email con intervallo di ${interval/1000}s`);

            try {
                for (let i = 0; i < recipients.length && bulkSending; i++) {
                    const recipient = recipients[i];
                    
                    try {
                        // Personalizza il contenuto per ogni destinatario
                        const personalizedSubject = replaceTemplateVariables(
                            document.getElementById('bulkEmailSubject').value, recipient, senderName, senderEmail
                        );
                        
                        const personalizedContent = generatePersonalizedEmail(recipient, senderName, senderEmail);

                        const emailData = {
                            to: recipient.email,
                            from: senderEmail,
                            fromName: senderName,
                            subject: personalizedSubject,
                            html: personalizedContent,
                            recipientName: recipient.nome || 'Client'
                        };

                        const response = await fetch('/send-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(emailData),
                            signal: bulkAbortController.signal
                        });

                        const result = await response.json();

                        if (result.success) {
                            sentEmails++;
                            addLog('success', `✅ ${recipient.email} - Inviata con successo (ID: ${result.messageId})`);
                        } else {
                            throw new Error(result.message);
                        }

                    } catch (error) {
                        if (error.name === 'AbortError') {
                            addLog('info', '⏹️ Invio interrotto dall\'utente');
                            break;
                        }
                        failedEmails++;
                        addLog('error', `❌ ${recipient.email} - Errore: ${error.message}`);
                    }

                    updateBulkStats(totalEmails, sentEmails, failedEmails);

                    // Pausa tra invii (se non è l'ultimo)
                    if (i < recipients.length - 1 && bulkSending) {
                        await new Promise(resolve => setTimeout(resolve, interval));
                    }
                }

            } catch (error) {
                addLog('error', `❌ Errore generale: ${error.message}`);
            } finally {
                bulkSending = false;
                document.getElementById('startBulkBtn').style.display = 'inline-block';
                document.getElementById('stopBulkBtn').style.display = 'none';

                if (sentEmails > 0) {
                    showBulkStatus('success', `✅ Invio completato! ${sentEmails} email inviate, ${failedEmails} fallite`);
                    addLog('info', `📊 Riepilogo: ${sentEmails} successi, ${failedEmails} errori su ${totalEmails} totali`);
                } else {
                    showBulkStatus('error', '❌ Nessuna email inviata con successo!');
                }
            }
        }

        // Ferma invio BULK
        function stopBulkSend() {
            if (bulkAbortController) {
                bulkAbortController.abort();
            }
            bulkSending = false;
            addLog('info', '⏹️ Invio BULK fermato dall\'utente');
            showBulkStatus('error', '⏹️ Invio fermato!');
        }

        // Genera email personalizzata
        function generatePersonalizedEmail(recipient, senderName, senderEmail) {
            const badge = document.getElementById('bulkBadge').value;
            const mainContent = replaceTemplateVariables(document.getElementById('bulkMainContent').value, recipient, senderName, senderEmail);
            const highlightContent = replaceTemplateVariables(document.getElementById('bulkHighlightContent').value, recipient, senderName, senderEmail);
            const additionalDetails = replaceTemplateVariables(document.getElementById('bulkAdditionalDetails').value, recipient, senderName, senderEmail);
            const conclusion = replaceTemplateVariables(document.getElementById('bulkConclusion').value, recipient, senderName, senderEmail);
            const ctaText = document.getElementById('bulkCtaText').value;
            const emailContact = document.getElementById('bulkEmailContact').value;
            const emailSubject = encodeURIComponent(replaceTemplateVariables(document.getElementById('bulkEmailSubject').value, recipient, senderName, senderEmail));
            const signature = replaceTemplateVariables(document.getElementById('bulkSignature').value, recipient, senderName, senderEmail);

            return emailTemplate
                .replace('{{BADGE}}', badge)
                .replace('{{MAIN_CONTENT}}', mainContent)
                .replace('{{HIGHLIGHT_CONTENT}}', highlightContent)
                .replace('{{ADDITIONAL_DETAILS}}', additionalDetails)
                .replace('{{CONCLUSION}}', conclusion)
                .replace('{{CTA_TEXT}}', ctaText)
                .replace('{{EMAIL_CONTACT}}', emailContact)
                .replace('{{EMAIL_SUBJECT}}', emailSubject)
                .replace('{{SIGNATURE}}', signature)
                .replace('{{RECIPIENT_NAME}}', recipient.nome || 'Client');
        }

        // Aggiorna statistiche BULK
        function updateBulkStats(total, sent, failed) {
            document.getElementById('totalEmails').textContent = total;
            document.getElementById('sentEmails').textContent = sent;
            document.getElementById('failedEmails').textContent = failed;
            document.getElementById('remainingEmails').textContent = total - sent - failed;
            
            const progress = total > 0 ? ((sent + failed) / total) * 100 : 0;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Mostra stato BULK
        function showBulkStatus(type, message) {
            const statusEl = document.getElementById('bulkStatusMessage');
            statusEl.className = `status-message status-${type}`;
            statusEl.innerHTML = message;
            statusEl.style.display = 'block';

            if (type !== 'loading') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 6000);
            }
        }

        // Aggiungi log
        function addLog(type, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Pulisci log BULK
        function clearBulkLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        // Reset form BULK
        function resetBulkForm() {
            if (confirm('Vuoi davvero resettare tutti i campi BULK?')) {
                document.getElementById('bulkEmailForm').reset();
                
                // Ripristina valori di default
                document.getElementById('bulkBadge').value = 'Nouvelle Collection Militaire';
                document.getElementById('bulkMainContent').value = `Bonjour {{nome}},

Nous sommes heureux de vous annoncer que nous venons de recevoir un nouveau stock de vêtements militaires. {{#azienda}}Nous savons que {{azienda}} recherche des équipements de qualité{{/azienda}} et nous avons une large sélection de vêtements de haute qualité, allant des uniformes complets aux accessoires tels que des sacs à dos, des casquettes et des gants.`;
                document.getElementById('bulkHighlightContent').value = `Si vous êtes intéressé par notre nouvelle collection, n'hésitez pas à nous contacter par e-mail. Nous serons ravis de répondre à vos questions et de vous fournir toutes les informations dont vous avez besoin.`;
                document.getElementById('bulkAdditionalDetails').value = 'Nos produits sont conçus pour les professionnels et les amateurs de militaria, et sont disponibles à des prix compétitifs.';
                document.getElementById('bulkConclusion').value = 'Nous espérons que vous trouverez ce que vous cherchez et que vous apprécierez nos produits.';
                document.getElementById('bulkCtaText').value = 'Contactez-nous';
                document.getElementById('bulkEmailSubject').value = 'Demande d\'information - {{nome}} - Vêtements militaires';
                document.getElementById('bulkSignature').value = 'L\'équipe FLEX TRADE';
                document.getElementById('sendInterval').value = '2';
                
                updateBulkPreview();
                showBulkStatus('success', '✅ Form BULK resettato ai valori di default!');
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            updatePreview();
            checkServer(); // Controlla subito lo stato del server
            
            const inputs = document.querySelectorAll('#emailForm input, #emailForm textarea, #emailForm select');
            inputs.forEach(input => {
                input.addEventListener('input', updatePreview);
                input.addEventListener('change', updatePreview);
            });

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Controllo iniziale del server
            checkServer();
            
            // Aggiorna anteprima iniziale
            updatePreview();
            
            // Auto-update anteprima in tempo reale per campi SINGLE
            const singleFields = [
                'badge', 'mainContent', 'highlightContent', 'additionalDetails', 
                'conclusion', 'ctaText', 'emailContact', 'emailSubject', 'signature', 'recipientName'
            ];
            
            singleFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updatePreview);
                    field.addEventListener('change', updatePreview);
                }
            });
            
            // Controlla il server ogni 30 secondi
            setInterval(checkServer, 30000);

            // Event listeners per modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            document.getElementById('codeModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // Event listeners per BULK
            const bulkInputs = document.querySelectorAll('#bulkEmailForm input, #bulkEmailForm textarea, #bulkEmailForm select');
            bulkInputs.forEach(input => {
                input.addEventListener('input', updateBulkPreview);
                input.addEventListener('change', updateBulkPreview);
            });

            // Inizializza la lista destinatari
            updateRecipientsList();
            updateBulkPreview();
        });
    </script>
</body>
</html>
